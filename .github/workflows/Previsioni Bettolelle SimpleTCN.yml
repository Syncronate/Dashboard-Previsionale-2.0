name: Previsioni Bettolelle SimpleTCN

on:
  schedule:
    # Esegue alle 00:00, 06:00, 12:00, 18:00
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Debug mode'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  predict:
    name: Genera Previsioni
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    env:
      GSHEET_ID: ${{ secrets.GSHEET_ID }}
      PYTHONUNBUFFERED: "1"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Verifica Files
        run: |
          echo "=== FILE PYTHON ==="
          ls -lh *.py || echo "Nessun file .py trovato nella root"
          echo ""
          echo "=== CHECKPOINT ==="
          ls -lh checkpoints/ || echo "Cartella checkpoints non trovata"
          echo ""
          echo "=== CONFIG ==="
          ls -lh *.yaml || echo "Nessun file yaml trovato"
      
      - name: Installa Dipendenze
        run: |
          python -m pip install --upgrade pip
          
          if [ -f "requirementsgit_2.txt" ]; then
            pip install -r requirementsgit_2.txt
          elif [ -f "requirementsgit.txt" ]; then
            pip install -r requirementsgit.txt
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "⚠️ Nessun requirements trovato. Installazione dipendenze base..."
            pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
            pip install pytorch-lightning==2.1.0
            pip install pandas numpy pyyaml gspread google-auth scikit-learn
          fi
          
          echo "=== Pacchetti Installati ==="
          pip list | grep -E "torch|lightning|pandas|gspread"
      
      - name: Crea Credenziali
        run: echo '${{ secrets.GCP_CREDENTIALS_JSON }}' > credentials.json
      
      - name: Test Import
        # Ho corretto questo blocco per evitare errori di sintassi YAML/Python
        run: |
          python -c "
          import sys
          sys.path.append('.')
          try:
              from models.lightning_wrapper import LitSpatioTemporalGNN
              from data.event_based_data_module import EventBasedDataModule
              print('✅ Import OK')
          except ImportError as e:
              print(f'❌ Import Error: {e}')
              sys.exit(1)
          "
      
      - name: Esegui Previsioni
        run: python predict_from_gsheets.py
        env:
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
      
      - name: Cleanup
        if: always()
        run: rm -f credentials.json
