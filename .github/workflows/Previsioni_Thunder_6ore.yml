# ==============================================================================
# Workflow Previsioni Bettolelle - SimpleTCN + Quantile Regression
# Modello: SimpleTCN con PyTorch Lightning
# Output: Previsioni a 6h (12 timestep) con 3 quantili (P10, P50, P90)
# ==============================================================================

name: Previsioni Bettolelle SimpleTCN

on:
  # Esecuzione automatica ogni 6 ore
  schedule:
    - cron: '0 */6 * * *'  # Alle 00:00, 06:00, 12:00, 18:00 UTC
  
  # Esecuzione manuale dalla UI di GitHub
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Abilita output debug dettagliato'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  predict:
    name: Genera Previsioni Idrologiche
    runs-on: ubuntu-latest
    
    # Timeout di sicurezza (10 minuti)
    timeout-minutes: 10
    
    env:
      GSHEET_ID: ${{ secrets.GSHEET_ID }}
      PYTHONUNBUFFERED: 1
      PYTHONIOENCODING: utf-8
    
    steps:
      # ========================================
      # 1. CHECKOUT REPOSITORY
      # ========================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true  # Scarica anche file LFS (checkpoints grandi)
      
      # ========================================
      # 2. SETUP PYTHON
      # ========================================
      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache automatica delle dipendenze
      
      # ========================================
      # 3. VERIFICA STRUTTURA FILE
      # ========================================
      - name: üîç Verifica Struttura Repository
        run: |
          echo "=== FILE PRINCIPALI ==="
          ls -lh *.py *.yaml 2>/dev/null || echo "Nessun file Python/YAML nella root"
          
          echo -e "\n=== CHECKPOINT ==="
          ls -lh checkpoints/*.ckpt 2>/dev/null || echo "‚ö†Ô∏è  Nessun checkpoint trovato!"
          
          echo -e "\n=== MODULI PYTHON ==="
          ls -lh models/*.py data/*.py preprocessing/*.py 2>/dev/null || echo "‚ö†Ô∏è  Moduli mancanti!"
          
          echo -e "\n=== FILE __init__.py ==="
          find . -name "__init__.py" -type f || echo "‚ö†Ô∏è  Nessun __init__.py trovato!"
      
      # ========================================
      # 4. INSTALLA DIPENDENZE
      # ========================================
      - name: üì¶ Installa Dipendenze
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # ‚ö†Ô∏è MODIFICATO: Cerca requirementsgit_2.txt, poi requirementsgit.txt, poi requirements.txt
          if [ -f "requirementsgit_2.txt" ]; then
            echo "üì• Installazione da requirementsgit_2.txt..."
            pip install -r requirementsgit_2.txt
          elif [ -f "requirementsgit.txt" ]; then
            echo "üì• Installazione da requirementsgit.txt..."
            pip install -r requirementsgit.txt
          elif [ -f "requirements.txt" ]; then
            echo "üì• Installazione da requirements.txt..."
            pip install -r requirements.txt
          else
            echo "‚ö†Ô∏è  Nessun file requirements trovato. Installo dipendenze base..."
            pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
            pip install pytorch-lightning==2.1.0
            pip install pandas numpy pyyaml gspread google-auth scikit-learn
          fi
          
          # Verifica installazione
          echo -e "\n=== PACCHETTI INSTALLATI ==="
          pip list | grep -E "torch|lightning|pandas|gspread|yaml"
      
      # ========================================
      # 5. CREA FILE CREDENZIALI
      # ========================================
      - name: üîë Crea Credenziali Google
        run: |
          echo '${{ secrets.GCP_CREDENTIALS_JSON }}' > credentials.json
          
          # Verifica che il file sia valido JSON
          if python -c "import json; json.load(open('credentials.json'))" 2>/dev/null; then
            echo "‚úÖ credentials.json creato correttamente"
          else
            echo "‚ùå ERRORE: credentials.json non √® un JSON valido!"
            exit 1
          fi
        shell: bash
      
      # ========================================
      # 6. VERIFICA CONFIGURAZIONE
      # ========================================
      - name: ‚öôÔ∏è Verifica Configurazione
        run: |
          echo "=== VARIABILI D'AMBIENTE ==="
          echo "GSHEET_ID: ${GSHEET_ID:0:20}..." # Mostra solo primi 20 caratteri
          echo "Python: $(python --version)"
          echo "PyTorch: $(python -c 'import torch; print(torch.__version__)')"
          
          echo -e "\n=== VALIDAZIONE CONFIG YAML ==="
          if [ -f "config_bettolelle_final.yaml" ]; then
            python -c "
import yaml
with open('config_bettolelle_final.yaml') as f:
    config = yaml.safe_load(f)
    print(f\"‚úÖ YAML valido\")
    print(f\"   - Input window: {config['data']['input_window']}\")
    print(f\"   - Output window: {config['data']['output_window']}\")
    print(f\"   - Quantili: {config['model']['quantile_levels']}\")
            "
          else
            echo "‚ùå config_bettolelle_final.yaml non trovato!"
            exit 1
          fi
          
          echo -e "\n=== VERIFICA GSHEET_ID ==="
          if [ -z "$GSHEET_ID" ]; then
            echo "‚ùå GSHEET_ID non configurato!"
            echo "üí° Vai su Settings ‚Üí Secrets ‚Üí Actions ‚Üí New repository secret"
            echo "   Nome: GSHEET_ID"
            echo "   Valore: ID del tuo Google Sheet"
            exit 1
          fi
          
          echo -e "\n=== VERIFICA SCRIPT PREVISIONI ==="
          if [ -f "predict_from_gsheets.py" ]; then
            echo "‚úÖ Script predict_from_gsheets.py trovato"
          else
            echo "‚ùå predict_from_gsheets.py non trovato!"
            exit 1
          fi
      
      # ========================================
      # 7. TEST IMPORT MODULI (OPZIONALE)
      # ========================================
      - name: üß™ Test Import Moduli
        run: |
          python -c "
import sys
sys.path.append('.')

try:
    from models.lightning_wrapper import LitSpatioTemporalGNN
    print('‚úÖ models.lightning_wrapper')
except ImportError as e:
    print(f'‚ùå models.lightning_wrapper: {e}')
    sys.exit(1)

try:
    from data.event_based_data_module import EventBasedDataModule
    print('‚úÖ data.event_based_data_module')
except ImportError as e:
    print(f'‚ùå data.event_based_data_module: {e}')
    sys.exit(1)

print('‚úÖ Tutti i moduli importati correttamente')
          "
      
      # ========================================
      # 8. ESEGUI PREVISIONI
      # ========================================
      - name: üöÄ Genera Previsioni
        id: predict
        run: |
          echo "=========================================="
          echo "üîÆ AVVIO PREVISIONI - $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "=========================================="
          
          # ‚úÖ CORRETTO: Esegui predict_from_gsheets.py invece di predict.py
          python predict_from_gsheets.py
          
          # Cattura exit code
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "=========================================="
            echo "‚úÖ PREVISIONI COMPLETATE CON SUCCESSO"
            echo "=========================================="
          else
            echo "=========================================="
            echo "‚ùå ERRORE DURANTE LE PREVISIONI (exit code: $EXIT_CODE)"
            echo "=========================================="
            exit $EXIT_CODE
          fi
        env:
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
      
      # ========================================
      # 9. DEBUG OUTPUT (solo se richiesto)
      # ========================================
      - name: üêõ Debug Output
        if: ${{ github.event.inputs.debug_mode == 'true' || failure() }}
        run: |
          echo "=== VERSIONI PACCHETTI ==="
          pip list
          
          echo -e "\n=== STRUTTURA COMPLETA ==="
          tree -L 3 || find . -maxdepth 3 -type f
          
          echo -e "\n=== ULTIMI LOG PYTHON ==="
          # Mostra eventuali file di log se creati
          find . -name "*.log" -type f -exec tail -n 50 {} \;
      
      # ========================================
      # 10. CLEANUP (opzionale)
      # ========================================
      - name: üßπ Cleanup
        if: always()
        run: |
          # Rimuovi credenziali per sicurezza
          rm -f credentials.json
          echo "‚úÖ Credenziali rimosse"
